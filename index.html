<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç•¶èˆ–ç®—å¸³å·¥å…·ï¼ˆç¾é‡‘æµ / æç›Šï¼‰</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", sans-serif; margin: 20px; }
    h1 { margin: 0 0 10px; }
    .muted { opacity: 0.7; font-size: 13px; margin-bottom: 10px; line-height: 1.5; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin: 10px 0; }
    input, select, button { padding: 8px 10px; font-size: 14px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: middle; }
    th { background: #f6f6f6; }
    td.num { text-align: right; white-space: nowrap; }
    .total { font-size: 16px; font-weight: 800; }
    button { cursor: pointer; }
    .danger { background: #fff; border: 1px solid #f0b4b4; }
    .primary { background: #111; color: #fff; border: 1px solid #111; }
    .ghost { background: #fff; border: 1px solid #ddd; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; }
    .gridSummary { display:grid; grid-template-columns: repeat(4, minmax(180px, 1fr)); gap: 10px; margin-top: 12px; }
    .card { border:1px solid #ddd; border-radius: 12px; padding: 10px 12px; }
    .card .k { font-size:12px; opacity:.7; }
    .card .v { font-size:18px; font-weight:800; margin-top:4px; }
  </style>
</head>
<body>
  <h1>ç•¶èˆ–å°å¸³ ğŸ§¾ğŸ”</h1>
  <div class="muted">
    è¦å‰‡ï¼šæ¯ 30 æ—¥ 1 æœŸï¼Œå–®åˆ© <span class="pill">4% / æœŸ</span>ã€‚<br/>
    æœŸæ•¸ç®—æ³•ï¼š<b>æœŸæ•¸ = floor(å¤©æ•¸/30) + (å¤©æ•¸%30 &gt; 15 ? 1 : 0)</b>ï¼ˆä¸è¶³ 30 å¤©ã€ŒéåŠã€æ‰é€²ä½ï¼‰ã€‚<br/>
    è´–å›æ—¥æœŸå¯ç©ºç™½ï¼šç©ºç™½æ™‚ç”¨ã€Œä»Šå¤©ã€ä¼°ç®—<b>æœªå¯¦ç¾æç›Š</b>èˆ‡<b>æ‡‰æ”¶å¸³æ¬¾</b>ã€‚
  </div>

  <div class="row">
    <label>æª”åï¼š
      <input id="filename" value="pawn_ledger" style="width: 160px" />
    </label>

    <label>å¹£åˆ¥ï¼š
      <select id="currency">
        <option value="TWD">TWD</option>
        <option value="MMK">MMK</option>
        <option value="THB">THB</option>
        <option value="USD">USD</option>
      </select>
    </label>

    <label>åˆ©ç‡ï¼š
      <input id="rate" type="number" step="0.01" min="0" value="4" style="width: 80px" />
      <span class="pill">% / æœŸ(30æ—¥)</span>
    </label>

    <button class="ghost" id="addRowBtn">+ æ–°å¢ä¸€ç­†</button>
    <button class="primary" id="exportBtn">åŒ¯å‡º XLSX</button>
    <button class="danger" id="clearBtn">æ¸…ç©º</button>
  </div>

  <div class="gridSummary">
    <div class="card">
      <div class="k">å·²ç™¼ç”Ÿç¾é‡‘æµåˆè¨ˆï¼ˆåˆ°ç›®å‰ï¼‰</div>
      <div class="v" id="sumCashflow">0</div>
    </div>
    <div class="card">
      <div class="k">å·²å¯¦ç¾æç›Šï¼ˆå·²è´–å›åˆ©æ¯ï¼‰</div>
      <div class="v" id="sumRealized">0</div>
    </div>
    <div class="card">
      <div class="k">æœªå¯¦ç¾æç›Šï¼ˆæœªè´–å›æ‡‰è¨ˆåˆ©æ¯ï¼‰</div>
      <div class="v" id="sumUnrealized">0</div>
    </div>
    <div class="card">
      <div class="k">æ‡‰æ”¶å¸³æ¬¾ï¼ˆæœªè´–å›æ‡‰æ”¶ç¸½é¡ï¼‰</div>
      <div class="v" id="sumReceivable">0</div>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th style="width:140px">å…¸ç•¶æ—¥æœŸ</th>
        <th style="width:140px">è´–å›æ—¥æœŸï¼ˆå¯ç©ºï¼‰</th>
        <th>ç•¶å“</th>
        <th style="width:140px">å®¢æˆ¶</th>
        <th style="width:120px">æœ¬é‡‘</th>
        <th style="width:80px">å¤©æ•¸</th>
        <th style="width:80px">æœŸæ•¸</th>
        <th style="width:120px">åˆ©æ¯</th>
        <th style="width:130px">æ‡‰æ”¶ç¸½é¡</th>
        <th style="width:140px">å·²ç™¼ç”Ÿç¾é‡‘æµ</th>
        <th style="width:140px">å·²å¯¦ç¾æç›Š</th>
        <th style="width:140px">æœªå¯¦ç¾æç›Š</th>
        <th style="width:140px">æ‡‰æ”¶å¸³æ¬¾</th>
        <th style="width:70px">æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    const tbody = document.getElementById('tbody');
    const currencyEl = document.getElementById('currency');
    const rateEl = document.getElementById('rate');

    const sumCashflowEl = document.getElementById('sumCashflow');
    const sumRealizedEl = document.getElementById('sumRealized');
    const sumUnrealizedEl = document.getElementById('sumUnrealized');
    const sumReceivableEl = document.getElementById('sumReceivable');

    function todayISO() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    function parseNum(v) {
      const n = Number(String(v).replace(/,/g,'').trim());
      return Number.isFinite(n) ? n : 0;
    }

    function fmt(n) {
      if (!Number.isFinite(n)) return '0';
      return n.toLocaleString(undefined, { maximumFractionDigits: 2 });
    }

    function daysBetween(d1, d2) {
      const a = new Date(d1 + 'T00:00:00');
      const b = new Date(d2 + 'T00:00:00');
      const ms = b - a;
      if (!Number.isFinite(ms)) return 0;
      return Math.max(0, Math.floor(ms / 86400000));
    }

    // ä¸è¶³30å¤©ï¼š>15 å¤©ç®— 1 æœŸï¼Œ<=15 å¤©ç®— 0 æœŸ
    // ä¸€èˆ¬æƒ…æ³ï¼šfloor(days/30) + (days%30>15 ? 1 : 0)
    function calcPeriods(days) {
      if (days <= 0) return 0;
      const full = Math.floor(days / 30);
      const rem = days % 30;
      return full + (rem > 15 ? 1 : 0);
    }

    function recalc() {
      const ccy = currencyEl.value;
      const rate = parseNum(rateEl.value) / 100; // 4 -> 0.04
      const now = todayISO();

      let sumCashflow = 0;
      let sumRealized = 0;
      let sumUnrealized = 0;
      let sumReceivable = 0;

      [...tbody.querySelectorAll('tr')].forEach(tr => {
        const pawnDate = tr.querySelector('[data-field="pawnDate"]').value;
        const redeemDate = tr.querySelector('[data-field="redeemDate"]').value;
        const principal = parseNum(tr.querySelector('[data-field="principal"]').value);

        // å…¸ç•¶åˆ°æˆªæ­¢æ—¥çš„åˆ©æ¯è¨ˆç®—ï¼šè´–å›æœ‰å¡«ç”¨è´–å›æ—¥ï¼Œæ²’å¡«ç”¨ä»Šå¤©ï¼ˆç”¨æ–¼æœªå¯¦ç¾/æ‡‰æ”¶ï¼‰
        const endDateForAccrual = redeemDate || now;
        const days = (pawnDate && endDateForAccrual) ? daysBetween(pawnDate, endDateForAccrual) : 0;
        const periods = calcPeriods(days);

        const interest = principal * rate * periods; // å–®åˆ©ï¼šæœ¬é‡‘ * åˆ©ç‡ * æœŸæ•¸
        const totalDue = principal + interest;

        const isRedeemed = Boolean(redeemDate);

        // ç¾é‡‘æµï¼ˆå·²ç™¼ç”Ÿï¼‰ï¼šå…¸ç•¶å…ˆä»˜å‡ºå» -æœ¬é‡‘ï¼›è‹¥å·²è´–å›ï¼Œå†æ”¶å› +æ‡‰æ”¶ç¸½é¡
        const cashflow = (-principal) + (isRedeemed ? totalDue : 0);

        // å·²å¯¦ç¾æç›Šï¼šåªæœ‰è´–å›æ‰ç®—åˆ©æ¯æ”¶å…¥
        const realizedPL = isRedeemed ? interest : 0;

        // æœªå¯¦ç¾æç›Šï¼šæœªè´–å›å°±æŠŠã€Œåˆ°ä»Šå¤©ã€æ‡‰è¨ˆåˆ©æ¯æ”¾é€™è£¡
        const unrealizedPL = isRedeemed ? 0 : interest;

        // æ‡‰æ”¶å¸³æ¬¾ï¼šæœªè´–å›æ‰æœ‰æ‡‰æ”¶ï¼ˆç”¨åˆ°ä»Šå¤©çš„è¨ˆç®—ï¼‰
        const receivable = isRedeemed ? 0 : totalDue;

        tr.querySelector('[data-field="days"]').textContent = String(days);
        tr.querySelector('[data-field="periods"]').textContent = String(periods);
        tr.querySelector('[data-field="interest"]').textContent = fmt(interest);
        tr.querySelector('[data-field="totalDue"]').textContent = fmt(totalDue);

        tr.querySelector('[data-field="cashflow"]').textContent = fmt(cashflow);
        tr.querySelector('[data-field="realized"]').textContent = fmt(realizedPL);
        tr.querySelector('[data-field="unrealized"]').textContent = fmt(unrealizedPL);
        tr.querySelector('[data-field="receivable"]').textContent = fmt(receivable);

        sumCashflow += cashflow;
        sumRealized += realizedPL;
        sumUnrealized += unrealizedPL;
        sumReceivable += receivable;
      });

      sumCashflowEl.textContent = `${fmt(sumCashflow)} ${ccy}`;
      sumRealizedEl.textContent = `${fmt(sumRealized)} ${ccy}`;
      sumUnrealizedEl.textContent = `${fmt(sumUnrealized)} ${ccy}`;
      sumReceivableEl.textContent = `${fmt(sumReceivable)} ${ccy}`;
    }

    function addRow(data = {}) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input data-field="pawnDate" type="date" value="${data.pawnDate ?? todayISO()}" /></td>
        <td><input data-field="redeemDate" type="date" value="${data.redeemDate ?? ''}" /></td>
        <td><input data-field="item" placeholder="ä¾‹å¦‚ï¼šé‡‘é£¾/æ‰‹æ©Ÿ/åéŒ¶" value="${data.item ?? ''}" style="width:100%" /></td>
        <td><input data-field="customer" placeholder="å§“å/ä»£è™Ÿ" value="${data.customer ?? ''}" style="width:100%" /></td>
        <td class="num"><input data-field="principal" type="number" step="0.01" min="0" value="${data.principal ?? 0}" style="width:110px" /></td>

        <td class="num" data-field="days">0</td>
        <td class="num" data-field="periods">0</td>
        <td class="num" data-field="interest">0</td>
        <td class="num" data-field="totalDue">0</td>

        <td class="num" data-field="cashflow">0</td>
        <td class="num" data-field="realized">0</td>
        <td class="num" data-field="unrealized">0</td>
        <td class="num" data-field="receivable">0</td>

        <td><button class="danger" data-action="del">åˆªé™¤</button></td>
      `;
      tbody.appendChild(tr);

      tr.addEventListener('input', recalc);
      tr.querySelector('[data-action="del"]').addEventListener('click', () => { tr.remove(); recalc(); });

      recalc();
    }

    function getRows() {
      const ccy = currencyEl.value;
      const ratePct = parseNum(rateEl.value);
      const now = todayISO();

      return [...tbody.querySelectorAll('tr')].map(tr => {
        const pawnDate = tr.querySelector('[data-field="pawnDate"]').value;
        const redeemDate = tr.querySelector('[data-field="redeemDate"]').value;
        const item = tr.querySelector('[data-field="item"]').value.trim();
        const customer = tr.querySelector('[data-field="customer"]').value.trim();
        const principal = parseNum(tr.querySelector('[data-field="principal"]').value);

        const endDate = redeemDate || now;
        const days = (pawnDate && endDate) ? daysBetween(pawnDate, endDate) : 0;
        const periods = calcPeriods(days);

        const interest = principal * (ratePct/100) * periods;
        const totalDue = principal + interest;

        const isRedeemed = Boolean(redeemDate);
        const cashflow = (-principal) + (isRedeemed ? totalDue : 0);
        const realizedPL = isRedeemed ? interest : 0;
        const unrealizedPL = isRedeemed ? 0 : interest;
        const receivable = isRedeemed ? 0 : totalDue;

        return {
          pawnDate,
          redeemDate: redeemDate || "",
          item,
          customer,
          principal,
          days,
          periods,
          ratePctPer30Days: ratePct,
          interest,
          totalDue,
          cashflow,
          realizedPL,
          unrealizedPL,
          receivable,
          currency: ccy,
          accrualToWhenRedeemEmpty: redeemDate ? "" : now
        };
      });
    }

    function exportXLSX() {
      const rows = getRows();

      const sheet1 = XLSX.utils.json_to_sheet(rows.map(r => ({
        å…¸ç•¶æ—¥æœŸ: r.pawnDate,
        è´–å›æ—¥æœŸ: r.redeemDate,
        ç•¶å“: r.item,
        å®¢æˆ¶: r.customer,
        æœ¬é‡‘: r.principal,
        å¤©æ•¸: r.days,
        æœŸæ•¸: r.periods,
        "åˆ©ç‡(%/æœŸ)": r.ratePctPer30Days,
        åˆ©æ¯: r.interest,
        æ‡‰æ”¶ç¸½é¡: r.totalDue,
        å·²ç™¼ç”Ÿç¾é‡‘æµ: r.cashflow,
        å·²å¯¦ç¾æç›Š: r.realizedPL,
        æœªå¯¦ç¾æç›Š: r.unrealizedPL,
        æ‡‰æ”¶å¸³æ¬¾: r.receivable,
        å¹£åˆ¥: r.currency,
        "è´–å›ç©ºç™½æ™‚è¨ˆç®—è‡³": r.accrualToWhenRedeemEmpty
      })));

      const ccy = currencyEl.value;
      const sum = rows.reduce((acc, r) => {
        acc.cashflow += r.cashflow;
        acc.realized += r.realizedPL;
        acc.unrealized += r.unrealizedPL;
        acc.receivable += r.receivable;
        acc.principal += r.principal;
        acc.count += 1;
        acc.open += r.redeemDate ? 0 : 1;
        acc.closed += r.redeemDate ? 1 : 0;
        return acc;
      }, { cashflow:0, realized:0, unrealized:0, receivable:0, principal:0, count:0, open:0, closed:0 });

      const sheet2 = XLSX.utils.json_to_sheet([
        { æŒ‡æ¨™: "å¹£åˆ¥", å€¼: ccy },
        { æŒ‡æ¨™: "æ¡ˆä»¶æ•¸", å€¼: sum.count },
        { æŒ‡æ¨™: "æœªè´–å›æ¡ˆä»¶æ•¸", å€¼: sum.open },
        { æŒ‡æ¨™: "å·²è´–å›æ¡ˆä»¶æ•¸", å€¼: sum.closed },
        { æŒ‡æ¨™: "", å€¼: "" },
        { æŒ‡æ¨™: "æœ¬é‡‘åˆè¨ˆ", å€¼: sum.principal },
        { æŒ‡æ¨™: "å·²ç™¼ç”Ÿç¾é‡‘æµåˆè¨ˆ", å€¼: sum.cashflow },
        { æŒ‡æ¨™: "å·²å¯¦ç¾æç›Šåˆè¨ˆ", å€¼: sum.realized },
        { æŒ‡æ¨™: "æœªå¯¦ç¾æç›Šåˆè¨ˆ", å€¼: sum.unrealized },
        { æŒ‡æ¨™: "æ‡‰æ”¶å¸³æ¬¾åˆè¨ˆ", å€¼: sum.receivable },
      ]);

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, sheet1, "å°å¸³");
      XLSX.utils.book_append_sheet(wb, sheet2, "å½™ç¸½");

      const filename = (document.getElementById('filename').value.trim() || 'pawn_ledger') + '.xlsx';
      XLSX.writeFile(wb, filename);
    }

    document.getElementById('addRowBtn').addEventListener('click', () => addRow());
    document.getElementById('exportBtn').addEventListener('click', exportXLSX);
    document.getElementById('clearBtn').addEventListener('click', () => { tbody.innerHTML = ''; addRow(); recalc(); });

    currencyEl.addEventListener('change', recalc);
    rateEl.addEventListener('input', recalc);

    addRow();
  </script>
</body>
</html>        <td><input data-field="date" type="date" value="${data.date ?? todayISO()}" /></td>
        <td><input data-field="name" placeholder="ä¾‹å¦‚ï¼šåˆé¤/è»Šç¥¨/è¨‚é–±" value="${data.name ?? ''}" style="width: 90%" /></td>
        <td style="display:flex;gap:6px;align-items:center">
          <select data-field="category">
            ${cats.map(c => `
              <option value="${c}" ${data.category===c ? 'selected' : ''}>${c}</option>
            `).join('')}
            <option value="__custom__" ${isCustom ? 'selected' : ''}>è‡ªè¨‚</option>
          </select>
          <input data-field="categoryCustom" placeholder="è‡ªè¨‚åˆ†é¡" value="${isCustom ? data.category : ''}" style="display:${isCustom ? 'inline-block' : 'none'}; width: 100px" />
        </td>
        <td class="num"><input data-field="qty" type="number" step="1" min="0" value="${data.qty ?? 1}" style="width: 80px" /></td>
        <td class="num"><input data-field="price" type="number" step="0.01" min="0" value="${data.price ?? 0}" style="width: 100px" /></td>
        <td class="num" data-field="subtotal">0</td>
        <td><input data-field="note" placeholder="..." value="${data.note ?? ''}" style="width: 90%" /></td>
        <td><button class="danger" data-action="del">åˆªé™¤</button></td>
      `;
      tbody.appendChild(tr);

      // toggle custom-category input visibility
      const sel = tr.querySelector('[data-field="category"]');
      const custom = tr.querySelector('[data-field="categoryCustom"]');
      sel.addEventListener('change', (e) => {
        if (sel.value === '__custom__') {
          custom.style.display = 'inline-block';
          custom.focus();
        } else {
          custom.style.display = 'none';
          custom.value = '';
        }
      });

      tr.addEventListener('input', (e) => {
        const t = e.target;
        if (t && (t.matches('[data-field="qty"]') || t.matches('[data-field="price"]') || t.matches('[data-field="categoryCustom"]'))) recalc();
      });

      tr.querySelector('[data-action="del"]').addEventListener('click', () => {
        tr.remove();
        recalc();
      });

      recalc();
    }

    function getRows() {
      return [...tbody.querySelectorAll('tr')].map(tr => {
        const date = tr.querySelector('[data-field="date"]').value;
        const name = tr.querySelector('[data-field="name"]').value.trim();
        const sel = tr.querySelector('[data-field="category"]');
        const customEl = tr.querySelector('[data-field="categoryCustom"]');
        const category = sel && sel.value === '__custom__' ? (customEl ? customEl.value.trim() : '') : (sel ? sel.value : '');
        const qty = parseNum(tr.querySelector('[data-field="qty"]').value);
        const price = parseNum(tr.querySelector('[data-field="price"]').value);
        const subtotal = qty * price;
        const note = tr.querySelector('[data-field="note"]').value.trim();
        return { date, name, category, qty, price, subtotal, note };
      });
    }

    function buildSummary(rows) {
      const byCat = new Map();
      for (const r of rows) {
        const k = r.category || "æœªåˆ†é¡";
        byCat.set(k, (byCat.get(k) || 0) + r.subtotal);
      }
      return [...byCat.entries()]
        .sort((a,b) => b[1]-a[1])
        .map(([category, total]) => ({ category, total }));
    }

    function exportXLSX() {
      const rows = getRows();
      const ccy = currencyEl.value;

      // Sheet 1: Details
      const sheet1 = XLSX.utils.json_to_sheet(rows.map(r => ({
        æ—¥æœŸ: r.date,
        é …ç›®: r.name,
        åˆ†é¡: r.category,
        æ•¸é‡: r.qty,
        å–®åƒ¹: r.price,
        å°è¨ˆ: r.subtotal,
        å¹£åˆ¥: ccy,
        å‚™è¨»: r.note
      })));

      // Sheet 2: Summary
      const summary = buildSummary(rows);
      const grand = rows.reduce((s,r) => s + r.subtotal, 0);
      const sheet2 = XLSX.utils.json_to_sheet([
        { æ¬„ç›®: "ç¸½ç­†æ•¸", å€¼: rows.length },
        { æ¬„ç›®: "ç¸½è¨ˆ", å€¼: grand, å¹£åˆ¥: ccy },
        { æ¬„ç›®: "", å€¼: "" },
        { æ¬„ç›®: "åˆ†é¡å½™ç¸½", å€¼: "" },
        ...summary.map(s => ({ æ¬„ç›®: s.category, å€¼: s.total, å¹£åˆ¥: ccy })),
      ]);

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, sheet1, "æ˜ç´°");
      XLSX.utils.book_append_sheet(wb, sheet2, "Summary");

      const filename = (document.getElementById('filename').value.trim() || 'ledger') + '.xlsx';
      XLSX.writeFile(wb, filename);
    }

    document.getElementById('addRowBtn').addEventListener('click', () => addRow());
    document.getElementById('exportBtn').addEventListener('click', exportXLSX);
    document.getElementById('clearBtn').addEventListener('click', () => {
      tbody.innerHTML = '';
      addRow();
      recalc();
    });
    currencyEl.addEventListener('change', recalc);

    addRow();
  </script>
</body>
</html>
